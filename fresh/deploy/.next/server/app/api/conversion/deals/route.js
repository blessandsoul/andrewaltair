"use strict";(()=>{var e={};e.id=3131,e.ids=[3131],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},91841:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>p});var a=r(49303),i=r(88716),n=r(60670),o=r(87070),d=r(75748),l=r(62154),u=r(93330);async function c(){try{await (0,d.Z)();let e=new Date,t=await l.Z.find({isActive:!0,expiresAt:{$gt:e}}).sort({expiresAt:1});return o.NextResponse.json({deals:t})}catch(e){return console.error("Deals GET Error:",e),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function p(e){try{await (0,d.Z)();let{dealId:t,userId:r}=await e.json();if(!t||!r)return o.NextResponse.json({error:"dealId and userId required"},{status:400});let s=await l.Z.findById(t);if(!s)return o.NextResponse.json({error:"Deal not found"},{status:404});if(new Date>s.expiresAt)return o.NextResponse.json({error:"Deal has expired"},{status:400});if(s.claimedSlots>=s.totalSlots)return o.NextResponse.json({error:"No slots remaining"},{status:400});if(s.claimedBy.includes(r))return o.NextResponse.json({error:"Already claimed"},{status:400});return s.claimedBy.push(r),s.claimedSlots+=1,await s.save(),"credits"===s.category&&s.discountedPrice&&await u.Z.findByIdAndUpdate(r,{$inc:{credits:s.discountedPrice}}),o.NextResponse.json({success:!0,code:s.code,message:"Deal claimed successfully"})}catch(e){return console.error("Deals POST Error:",e),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/conversion/deals/route",pathname:"/api/conversion/deals",filename:"route",bundlePath:"app/api/conversion/deals/route"},resolvedPagePath:"C:\\Users\\User\\Desktop\\GITHUB\\andrewaltair\\fresh\\src\\app\\api\\conversion\\deals\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:g}=m,v="/api/conversion/deals/route";function h(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},75748:(e,t,r)=>{r.d(t,{Z:()=>o});var s=r(11185),a=r.n(s);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let n=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=n);let o=async function(){if(n.conn)return n.conn;n.promise||(n.promise=a().connect(i,{bufferCommands:!1}).then(e=>e));try{n.conn=await n.promise}catch(e){throw n.promise=null,e}return n.conn}},62154:(e,t,r)=>{r.d(t,{Z:()=>n});var s=r(11185),a=r.n(s);let i=new s.Schema({title:{type:String,required:[!0,"Title is required"],trim:!0},description:{type:String,required:[!0,"Description is required"]},discount:{type:Number,required:!0,min:1,max:100},originalPrice:Number,discountedPrice:Number,code:String,expiresAt:{type:Date,required:!0},totalSlots:{type:Number,default:100},claimedSlots:{type:Number,default:0},claimedBy:[{type:s.Schema.Types.ObjectId,ref:"User"}],isActive:{type:Boolean,default:!0},category:{type:String,enum:["subscription","credits","course","consultation"],default:"credits"}},{timestamps:!0});i.index({isActive:1,expiresAt:1});let n=a().models.Deal||a().model("Deal",i)},93330:(e,t,r)=>{r.d(t,{Z:()=>o});var s=r(11185),a=r.n(s),i=r(98691);let n=new s.Schema({username:{type:String,required:[!0,"Username is required"],unique:!0,trim:!0,minlength:[3,"Username must be at least 3 characters"],maxlength:[30,"Username must be less than 30 characters"]},email:{type:String,required:[!0,"Email is required"],unique:!0,trim:!0,lowercase:!0,match:[/^\S+@\S+\.\S+$/,"Please enter a valid email"]},password:{type:String,required:[!0,"Password is required"],minlength:[6,"Password must be at least 6 characters"],select:!1},fullName:{type:String,required:[!0,"Full name is required"],trim:!0},bio:{type:String,default:void 0},avatar:{type:String,default:void 0},coverImage:{type:String,default:void 0},coverOffsetY:{type:Number,default:0},role:{type:String,enum:["god","admin","editor","viewer"],default:"viewer"},badge:{type:String,default:void 0},isBlocked:{type:Boolean,default:!1},twoFactorEnabled:{type:Boolean,default:!1},twoFactorSecret:{type:String,select:!1},backupCodes:{type:[String],select:!1},lastLogin:{type:Date,default:void 0},credits:{type:Number,default:0},mysteryBox:{lastClaimedAt:{type:Date},streak:{type:Number,default:0}},gamification:{xp:{type:Number,default:0},level:{type:Number,default:1},streak:{type:Number,default:0},completedQuests:[{type:String}],completedLessons:[{type:String}],unlockedSkills:{type:[String],default:["prompt-basics"]}}},{timestamps:!0});n.pre("save",async function(){if(!this.isModified("password"))return;let e=await i.ZP.genSalt(10);this.password=await i.ZP.hash(this.password,e)}),n.methods.comparePassword=async function(e){return i.ZP.compare(e,this.password)},n.statics.findByCredentials=async function(e,t){let r=await this.findOne({email:e}).select("+password");if(!r||!await r.comparePassword(t))throw Error("Invalid credentials");return r};let o=a().models.User||a().model("User",n)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,8691],()=>r(91841));module.exports=s})();