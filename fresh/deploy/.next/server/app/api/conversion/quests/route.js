"use strict";(()=>{var e={};e.id=7307,e.ids=[7307],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},33560:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>l,POST:()=>c});var a=r(49303),n=r(88716),i=r(60670),o=r(87070),d=r(75748),p=r(57042),u=r(93330);async function l(e){try{await (0,d.Z)();let{searchParams:t}=new URL(e.url),r=t.get("userId"),s=(await p.Z.find({isActive:!0}).lean()).map(e=>{let t=e.participants?.find(e=>e.userId?.toString()===r);return{...e,userProgress:t?{started:!0,completedSteps:t.completedSteps||[],isComplete:null!=t.completedAt}:{started:!1,completedSteps:[],isComplete:!1}}});return o.NextResponse.json({quests:s})}catch(e){return console.error("Quests GET Error:",e),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function c(e){try{await (0,d.Z)();let{questId:t,userId:r,stepId:s,action:a}=await e.json();if(!t||!r)return o.NextResponse.json({error:"questId and userId required"},{status:400});let n=await p.Z.findById(t);if(!n)return o.NextResponse.json({error:"Quest not found"},{status:404});let i=n.participants.find(e=>e.userId?.toString()===r);if("start"===a){if(i)return o.NextResponse.json({success:!0,message:"Already started"});return n.participants.push({userId:r,completedSteps:[],startedAt:new Date}),await n.save(),o.NextResponse.json({success:!0,message:"Quest started"})}if("complete_step"===a&&s){if(!i)return o.NextResponse.json({error:"Quest not started"},{status:400});if(i.completedSteps.includes(s))return o.NextResponse.json({success:!0,alreadyCompleted:!0});let e=n.steps.find(e=>e.id===s);if(!e)return o.NextResponse.json({error:"Step not found"},{status:404});let a=n.participants.findIndex(e=>e.userId?.toString()===r);n.participants[a].completedSteps.push(s);let d=n.steps.every(e=>n.participants[a].completedSteps.includes(e.id));return d&&(n.participants[a].completedAt=new Date),await n.save(),await u.Z.findByIdAndUpdate(r,{$inc:{"gamification.xp":e.xpReward},$addToSet:{"gamification.completedQuests":d?t:void 0}}),o.NextResponse.json({success:!0,xpEarned:e.xpReward,questCompleted:d})}return o.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Quests POST Error:",e),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/conversion/quests/route",pathname:"/api/conversion/quests",filename:"route",bundlePath:"app/api/conversion/quests/route"},resolvedPagePath:"C:\\Users\\User\\Desktop\\GITHUB\\andrewaltair\\fresh\\src\\app\\api\\conversion\\quests\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:g}=m,S="/api/conversion/quests/route";function v(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:y})}},75748:(e,t,r)=>{r.d(t,{Z:()=>o});var s=r(11185),a=r.n(s);let n=process.env.MONGODB_URI;if(!n)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let i=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=i);let o=async function(){if(i.conn)return i.conn;i.promise||(i.promise=a().connect(n,{bufferCommands:!1}).then(e=>e));try{i.conn=await i.promise}catch(e){throw i.promise=null,e}return i.conn}},57042:(e,t,r)=>{r.d(t,{Z:()=>o});var s=r(11185),a=r.n(s);let n=new s.Schema({id:{type:String,required:!0},title:{type:String,required:!0},description:{type:String,required:!0},xpReward:{type:Number,default:10}}),i=new s.Schema({title:{type:String,required:[!0,"Title is required"],trim:!0},description:{type:String,required:[!0,"Description is required"]},steps:[n],totalXp:{type:Number,default:0},difficulty:{type:String,enum:["easy","medium","hard","legendary"],default:"easy"},category:{type:String,enum:["learning","engagement","social","achievement"],default:"learning"},participants:[{userId:{type:s.Schema.Types.ObjectId,ref:"User"},completedSteps:[String],startedAt:{type:Date,default:Date.now},completedAt:Date}],isActive:{type:Boolean,default:!0},expiresAt:Date},{timestamps:!0});i.index({isActive:1}),i.index({"participants.userId":1});let o=a().models.Quest||a().model("Quest",i)},93330:(e,t,r)=>{r.d(t,{Z:()=>o});var s=r(11185),a=r.n(s),n=r(98691);let i=new s.Schema({username:{type:String,required:[!0,"Username is required"],unique:!0,trim:!0,minlength:[3,"Username must be at least 3 characters"],maxlength:[30,"Username must be less than 30 characters"]},email:{type:String,required:[!0,"Email is required"],unique:!0,trim:!0,lowercase:!0,match:[/^\S+@\S+\.\S+$/,"Please enter a valid email"]},password:{type:String,required:[!0,"Password is required"],minlength:[6,"Password must be at least 6 characters"],select:!1},fullName:{type:String,required:[!0,"Full name is required"],trim:!0},bio:{type:String,default:void 0},avatar:{type:String,default:void 0},coverImage:{type:String,default:void 0},coverOffsetY:{type:Number,default:0},role:{type:String,enum:["god","admin","editor","viewer"],default:"viewer"},badge:{type:String,default:void 0},isBlocked:{type:Boolean,default:!1},twoFactorEnabled:{type:Boolean,default:!1},twoFactorSecret:{type:String,select:!1},backupCodes:{type:[String],select:!1},lastLogin:{type:Date,default:void 0},credits:{type:Number,default:0},mysteryBox:{lastClaimedAt:{type:Date},streak:{type:Number,default:0}},gamification:{xp:{type:Number,default:0},level:{type:Number,default:1},streak:{type:Number,default:0},completedQuests:[{type:String}],completedLessons:[{type:String}],unlockedSkills:{type:[String],default:["prompt-basics"]}}},{timestamps:!0});i.pre("save",async function(){if(!this.isModified("password"))return;let e=await n.ZP.genSalt(10);this.password=await n.ZP.hash(this.password,e)}),i.methods.comparePassword=async function(e){return n.ZP.compare(e,this.password)},i.statics.findByCredentials=async function(e,t){let r=await this.findOne({email:e}).select("+password");if(!r||!await r.comparePassword(t))throw Error("Invalid credentials");return r};let o=a().models.User||a().model("User",i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,8691],()=>r(33560));module.exports=s})();